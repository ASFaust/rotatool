<!-- templates/people.html -->
{% extends 'base.html' %}

{% block content %}
<h1>People</h1>
<p>Manage people here.</p>

<table class="people-table">
    <thead>
        <tr>
            <th>Name</th>
            <th>Start Date</th>
            <th>Leaving Date</th>
            <th>Leader</th>
            <th>Part Time</th>
            <th>Days Off Past</th>
            <th>Days Off Total</th>
            <th>Day Off Every</th>
            <th>Skills</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        <!-- templates/people.html -->
        {% for item in people %}
        <tr>
            <td>{{ item.person.name }}</td>
            <td>{{ item.person.start_date }}</td>
            <td>{{ item.person.leaving_date }}</td>
            <td>{{ 'Yes' if item.person.leader else 'No' }}</td>
            <td>{{ 'Yes' if item.person.part_time else 'No' }}</td>
            <td>{{ item.person.days_off_past }}</td>
            <td>{{ item.person.days_off_total }}</td>
            <td>{{ item.person.day_off_every }}</td>
            <td>{{ item.skills | join(', ') }}</td>
            <td>
                <button type="button" class="edit-button" onclick="editPerson('{{ item.person.id }}')">Edit</button>
                <form action="/people/delete_person/{{ item.person.id }}" method="POST" style="display:inline;" onsubmit="confirmDelete(event)">
                    <button type="submit" class="delete-button">Delete</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div id="editForm" style="display: none;">
    <h3>Editing <span id="editPersonName"></span></h3>
    <form id="editPersonForm" action="/people/edit_person" method="POST">
        <input type="hidden" id="editPersonId" name="id">
        <table>
            <tr>
                <td><label for="editName">Name:</label></td>
                <td><input type="text" id="editName" name="name" required></td>
            </tr>
            <tr>
                <td><label for="editStartDate">Start Date:</label></td>
                <td><input type="date" id="editStartDate" name="start_date" required></td>
            </tr>
            <tr>
                <td><label for="editLeavingDate">Leaving Date:</label></td>
                <td><input type="date" id="editLeavingDate" name="leaving_date" required></td>
            </tr>
            <tr>
                <td><label for="editLeader">Leader:</label></td>
                <td><input type="checkbox" id="editLeader" name="leader"></td>
            </tr>
            <tr>
                <td><label for="editPartTime">Part Time:</label></td>
                <td><input type="checkbox" id="editPartTime" name="part_time"></td>
            </tr>
            <tr>
                <td><label for="editDaysOffPast">Days Off Past:</label></td>
                <td><input type="number" id="editDaysOffPast" name="days_off_past"></td>
            </tr>
            <tr>
                <td><label for="editDaysOffTotal">Days Off Total:</label></td>
                <td><input type="number" id="editDaysOffTotal" name="days_off_total"></td>
            </tr>
            <tr>
                <td><label for="editDayOffEvery">Day Off Every:</label></td>
                <td><input type="number" id="editDayOffEvery" name="day_off_every" required></td>
            </tr>
            <tr>
                <td style="vertical-align: top;"><label for="editSkills">Skills:</label></td>
                <td>
                    <div id="editSkillsContainer" style="font-size: 0.9em; margin-bottom: 10px;">
                        <!-- Existing skills will be displayed here -->
                    </div>
                    <div id="editNewSkillContainer" style="display: flex; align-items: center;">
                        <select id="editNewSkillSelect">
                            {% for skill in skills %}
                            <option value="{{ skill.id }}">{{ skill.name }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" onclick="addEditSkill()" style="margin-left: 10px;">Add Skill</button>
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <button type="submit">Save</button>
                    <button type="button" onclick="cancelEdit()">Cancel</button>
                </td>
            </tr>
        </table>
    </form>
</div>

<form id="addPersonForm" action="/people/add_person" method="POST">
    <h3>Add Person</h3>
    <table>
        <tr>
            <td><label for="name">Name:</label></td>
            <td><input type="text" name="name" required></td>
        </tr>
        <tr>
            <td><label for="start_date">Start Date:</label></td>
            <td><input type="date" name="start_date" required></td>
        </tr>
        <tr>
            <td><label for="leaving_date">Leaving Date:</label></td>
            <td><input type="date" name="leaving_date" required></td>
        </tr>
        <tr>
            <td><label for="leader">Leader:</label></td>
            <td><input type="checkbox" name="leader"></td>
        </tr>
        <tr>
            <td><label for="part_time">Part Time:</label></td>
            <td><input type="checkbox" name="part_time"></td>
        </tr>
        <tr>
            <td><label for="days_off_past">Days Off Past:</label></td>
            <td><input type="number" name="days_off_past"></td>
        </tr>
        <tr>
            <td><label for="days_off_total">Days Off Total:</label></td>
            <td><input type="number" name="days_off_total"></td>
        </tr>
        <tr>
            <td><label for="day_off_every">Day Off Every:</label></td>
            <td><input type="number" name="day_off_every" required></td>
        </tr>
        <tr>
            <td style="vertical-align: top;"><label for="skills">Skills:</label></td>
            <td>
                <div id="skillsContainer" style="font-size: 0.9em; margin-bottom: 10px;">
                    <!-- Existing skills will be displayed here -->
                </div>
                <div id="newSkillContainer" style="display: flex; align-items: center;">
                    <select id="newSkillSelect">
                        {% for skill in skills %}
                        <option value="{{ skill.id }}">{{ skill.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" onclick="addSkill()" style="margin-left: 10px;">Add Skill</button>
                </div>
            </td>
        </tr>
        <tr>
            <td colspan="2"><button type="submit">Add Person</button></td>
        </tr>
    </table>
</form>

<script>
function addSkill() {
    var select = document.getElementById('newSkillSelect');
    var selectedSkillId = select.value;
    var selectedSkillName = select.options[select.selectedIndex].text;

    var container = document.getElementById('skillsContainer');
    var skillDiv = document.createElement('div');
    skillDiv.className = 'skill-item';
    skillDiv.dataset.skillId = selectedSkillId;

    var skillNameSpan = document.createElement('span');
    skillNameSpan.textContent = selectedSkillName;
    skillDiv.appendChild(skillNameSpan);

    var removeButton = document.createElement('span');
    removeButton.textContent = ' x';
    removeButton.style.cursor = 'pointer';
    removeButton.style.color = 'red';
    removeButton.style.marginLeft = '5px';
    removeButton.onclick = function() {
        container.removeChild(skillDiv);
    };
    skillDiv.appendChild(removeButton);

    var hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'skills';
    hiddenInput.value = selectedSkillId;
    skillDiv.appendChild(hiddenInput);

    container.appendChild(skillDiv);
}

function addEditSkill() {
    var select = document.getElementById('editNewSkillSelect');
    var selectedSkillId = select.value;
    var selectedSkillName = select.options[select.selectedIndex].text;

    var container = document.getElementById('editSkillsContainer');
    var skillDiv = document.createElement('div');
    skillDiv.className = 'skill-item';
    skillDiv.dataset.skillId = selectedSkillId;

    var skillNameSpan = document.createElement('span');
    skillNameSpan.textContent = selectedSkillName;
    skillDiv.appendChild(skillNameSpan);

    var removeButton = document.createElement('span');
    removeButton.textContent = ' x';
    removeButton.style.cursor = 'pointer';
    removeButton.style.color = 'red';
    removeButton.style.marginLeft = '5px';
    removeButton.onclick = function() {
        container.removeChild(skillDiv);
    };
    skillDiv.appendChild(removeButton);

    var hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'skills';
    hiddenInput.value = selectedSkillId;
    skillDiv.appendChild(hiddenInput);

    container.appendChild(skillDiv);
}
function editPerson(id) {
    fetch(`/people/get_person/${id}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('editForm').style.display = 'block';
            document.getElementById('addPersonForm').style.display = 'none';
            document.getElementById('editPersonName').textContent = data.name;
            document.getElementById('editPersonId').value = data.id;
            document.getElementById('editName').value = data.name;
            document.getElementById('editStartDate').value = data.start_date;
            document.getElementById('editLeavingDate').value = data.leaving_date;
            document.getElementById('editLeader').checked = data.leader;
            document.getElementById('editPartTime').checked = data.part_time;
            document.getElementById('editDaysOffPast').value = data.days_off_past;
            document.getElementById('editDaysOffTotal').value = data.days_off_total;
            document.getElementById('editDayOffEvery').value = data.day_off_every;

            var container = document.getElementById('editSkillsContainer');
            container.innerHTML = '';
            data.skills.forEach(function(skill) {
                var skillDiv = document.createElement('div');
                skillDiv.className = 'skill-item';
                skillDiv.dataset.skillId = skill.id;

                var skillNameSpan = document.createElement('span');
                skillNameSpan.textContent = skill.name;
                skillDiv.appendChild(skillNameSpan);

                var removeButton = document.createElement('span');
                removeButton.textContent = ' x';
                removeButton.style.cursor = 'pointer';
                removeButton.style.color = 'red';
                removeButton.style.marginLeft = '5px';
                removeButton.onclick = function() {
                    container.removeChild(skillDiv);
                };
                skillDiv.appendChild(removeButton);

                var hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'skills';
                hiddenInput.value = skill.id;
                skillDiv.appendChild(hiddenInput);

                container.appendChild(skillDiv);
            });
        });
}

function cancelEdit() {
    document.getElementById('editForm').style.display = 'none';
    document.getElementById('addPersonForm').style.display = 'block';
    document.getElementById('editPersonForm').reset();
}

function confirmDelete(event) {
    if (!confirm("Do you really want to delete?")) {
        event.preventDefault();
    }
}
</script>
{% endblock %}