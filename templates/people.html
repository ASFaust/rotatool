{% extends 'base.html' %}
{% block content %}
<h1>People</h1>
<p>Manage people here.</p>

<table class="people-table">
    <thead>
        <tr>
            <th>Name</th>
            <th>Start Date</th>
            <th>Leaving Date</th>
            <th>Leader</th>
            <th>Part Time</th>
            <th>Skills</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for item in people %}
        <tr class="{{ 'deactivated' if not item.person.activated else '' }}">
            <td>{{ item.person.name }}</td>
            <td>{{ item.person.start_date }}</td>
            <td>{{ item.person.leaving_date }}</td>
            <td>{{ 'Yes' if item.person.leader else 'No' }}</td>
            <td>{{ 'Yes' if item.person.part_time else 'No' }}</td>
            <td>{{ item.skills | join(', ') }}</td>
            <td>
                <button type="button" class="edit-button" onclick="editPerson('{{ item.person.id }}')">Edit</button>
                <form action="/people/delete_person/{{ item.person.id }}" method="POST" style="display:inline;" onsubmit="confirmDelete(event)">
                    <button type="submit" class="delete-button">Delete</button>
                </form>
                <button type="button" class="deactivate-button" onclick="toggleActive('{{ item.person.id }}', {{ 'true' if item.person.activated else 'false' }})">
                    {{ 'Deactivate' if item.person.activated else 'Activate' }}
                </button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div id="personFormContainer">
    <h3 id="formTitle">Add Person</h3> <!-- Title changes dynamically -->
    <form id="personForm" action="{{ url_for('people.add_person') }}" method="POST"> <!-- Action will be changed dynamically -->
        <input type="hidden" id="personId" name="id"> <!-- Hidden input for person ID (for editing) -->
        <table>
            <tr>
                <td><label for="name">Name:</label></td>
                <td><input type="text" id="name" name="name" required></td>
            </tr>
            <tr>
                <td><label for="start_date">Start Date:</label></td>
                <td><input type="date" id="start_date" name="start_date" required></td>
            </tr>
            <tr>
                <td><label for="leaving_date">Leaving Date:</label></td>
                <td><input type="date" id="leaving_date" name="leaving_date" required></td>
            </tr>
            <tr>
                <td><label for="leader">Leader:</label></td>
                <td><input type="checkbox" id="leader" name="leader"></td>
            </tr>
            <tr>
                <td><label for="part_time">Part Time:</label></td>
                <td><input type="checkbox" id="part_time" name="part_time"></td>
            </tr>
            <tr>
                <td style="vertical-align: top;"><label for="skills">Skills:</label></td>
                <td>
                    <div id="skillsContainer" style="font-size: 0.9em; margin-bottom: 10px;">
                        <!-- Existing skills will be displayed here -->
                    </div>
                    <div id="newSkillContainer" style="display: flex; align-items: center;">
                        <select id="newSkillSelect">
                            {% for skill in skills %}
                            <option value="{{ skill.id }}">{{ skill.name }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" onclick="addSkill()" style="margin-left: 10px;">Add Skill</button>
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <button type="submit" id="formSubmitButton">Add Person</button>
                    <button type="button" id="cancelEditButton" onclick="switchToAddMode()" style="display: none;">Cancel</button>
                </td>
            </tr>
        </table>
    </form>
</div>

<script>
function toggleActive(personId, isActive) {
    var action = isActive ? 'deactivate' : 'activate';
    fetch(`/people/${action}_person/${personId}`, {
        method: 'POST'
    }).then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to update person status.');
        }
    });
}

function addSkill() {
    var select = document.getElementById('newSkillSelect');
    var selectedSkillId = select.value;
    var selectedSkillName = select.options[select.selectedIndex].text;

    var container = document.getElementById('skillsContainer');
    var skillDiv = document.createElement('div');
    skillDiv.className = 'skill-item';
    skillDiv.dataset.skillId = selectedSkillId;

    var skillNameSpan = document.createElement('span');
    skillNameSpan.textContent = selectedSkillName;
    skillDiv.appendChild(skillNameSpan);

    var removeButton = document.createElement('span');
    removeButton.textContent = ' x';
    removeButton.style.cursor = 'pointer';
    removeButton.style.color = 'red';
    removeButton.style.marginLeft = '5px';
    removeButton.onclick = function() {
        container.removeChild(skillDiv);
    };
    skillDiv.appendChild(removeButton);

    var hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'skills';
    hiddenInput.value = selectedSkillId;
    skillDiv.appendChild(hiddenInput);

    container.appendChild(skillDiv);
}

function switchToEditMode(personData) {
    // Set form title, action URL, and button text for editing
    document.getElementById('formTitle').textContent = 'Edit Person: ' + personData.name;
    document.getElementById('personForm').action = "{{ url_for('people.edit_person') }}";
    document.getElementById('formSubmitButton').textContent = 'Save Changes';
    document.getElementById('cancelEditButton').style.display = 'inline'; // Show "Cancel Edit" button

    // Populate form fields with the person data
    document.getElementById('personId').value = personData.id;
    document.getElementById('name').value = personData.name;
    document.getElementById('start_date').value = personData.start_date;
    document.getElementById('leaving_date').value = personData.leaving_date;
    document.getElementById('leader').checked = personData.leader;
    document.getElementById('part_time').checked = personData.part_time;

    // Populate the skills container
    var container = document.getElementById('skillsContainer');
    container.innerHTML = ''; // Clear existing skills
    personData.skills.forEach(function(skill) {
        var skillDiv = document.createElement('div');
        skillDiv.className = 'skill-item';
        skillDiv.dataset.skillId = skill.id;

        var skillNameSpan = document.createElement('span');
        skillNameSpan.textContent = skill.name;
        skillDiv.appendChild(skillNameSpan);

        var removeButton = document.createElement('span');
        removeButton.textContent = ' x';
        removeButton.style.cursor = 'pointer';
        removeButton.style.color = 'red';
        removeButton.style.marginLeft = '5px';
        removeButton.onclick = function() {
            container.removeChild(skillDiv);
        };
        skillDiv.appendChild(removeButton);

        var hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'skills';
        hiddenInput.value = skill.id;
        skillDiv.appendChild(hiddenInput);

        container.appendChild(skillDiv);
    });
    document.getElementById('personFormContainer').scrollIntoView({ behavior: 'smooth' });

}

function switchToAddMode() {
    // Set form title, action URL, and button text for adding
    document.getElementById('formTitle').textContent = 'Add Person';
    document.getElementById('personForm').action = "{{ url_for('people.add_person') }}";
    document.getElementById('formSubmitButton').textContent = 'Add Person';
    document.getElementById('cancelEditButton').style.display = 'none'; // Hide "Cancel Edit" button

    // Clear form fields
    document.getElementById('personId').value = '';
    document.getElementById('name').value = '';
    document.getElementById('start_date').value = '';
    document.getElementById('leaving_date').value = '';
    document.getElementById('leader').checked = false;
    document.getElementById('part_time').checked = false;

    // Clear skills container
    document.getElementById('skillsContainer').innerHTML = '';
}

function editPerson(id) {
    fetch(`/people/get_person/${id}`)
        .then(response => response.json())
        .then(data => {
            switchToEditMode(data);
        });
}

function confirmDelete(event) {
    if (!confirm("Do you really want to delete?")) {
        event.preventDefault();
    }
}
</script>
{% endblock %}